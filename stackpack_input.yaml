constraints:
- node: aws:ecr_image:gitea
  operator: must_exist
  scope: application
- node: aws:ecs_service:gitea-service
  operator: must_exist
  scope: application
- node: aws:ecs_task_definition:gitea-task
  operator: must_exist
  scope: application
- node: aws:load_balancer:gitea-lb
  operator: must_exist
  scope: application
- node: aws:load_balancer_listener:gitea-lb:gitea-web
  operator: must_exist
  scope: application
- node: aws:target_group:gitea-web
  operator: must_exist
  scope: application
- node: aws:load_balancer_listener:gitea-lb:gitea-ssh
  operator: must_exist
  scope: application
- node: aws:target_group:gitea-ssh
  operator: must_exist
  scope: application
- node: aws:efs_file_system:gitea-efs
  operator: must_exist
  scope: application
- node: aws:efs_access_point:gitea-efs:gitea-data
  operator: must_exist
  scope: application
- node: aws:efs_access_point:gitea-efs:gitea-ssh
  operator: must_exist
  scope: application
- node: aws:rds_instance:gitea-db
  operator: must_exist
  scope: application
- operator: equals
  property: BaseImage
  scope: resource
  target: aws:ecr_image:gitea
  value: gitea/gitea:latest
- operator: equals
  property: LoadBalancers[0].ContainerPort
  scope: resource
  target: aws:ecs_service:gitea-service
  value: 3000
- operator: equals
  property: LoadBalancers[0].TargetGroup
  scope: resource
  target: aws:ecs_service:gitea-service
  value: aws:target_group:gitea-web
- operator: equals
  property: LoadBalancers[0].ContainerName
  scope: resource
  target: aws:ecs_service:gitea-service
  value: gitea-task
- operator: equals
  property: LoadBalancers[1].ContainerPort
  scope: resource
  target: aws:ecs_service:gitea-service
  value: 2222
- operator: equals
  property: LoadBalancers[1].TargetGroup
  scope: resource
  target: aws:ecs_service:gitea-service
  value: aws:target_group:gitea-ssh
- operator: equals
  property: LoadBalancers[1].ContainerName
  scope: resource
  target: aws:ecs_service:gitea-service
  value: gitea-task
- operator: equals
  property: TaskDefinition
  scope: resource
  target: aws:ecs_service:gitea-service
  value: aws:ecs_task_definition:gitea-task
- operator: equals
  property: EnableExecuteCommand
  scope: resource
  target: aws:ecs_service:gitea-service
  value: true
- operator: equals
  property: Cpu
  scope: resource
  target: aws:ecs_task_definition:gitea-task
  value: 512
- operator: equals
  property: Memory
  scope: resource
  target: aws:ecs_task_definition:gitea-task
  value: 2048
- operator: equals
  property: ContainerDefinitions[0].Image
  scope: resource
  target: aws:ecs_task_definition:gitea-task
  value: aws:ecr_image:gitea
- operator: equals
  property: ContainerDefinitions[0].PortMappings[0].ContainerPort
  scope: resource
  target: aws:ecs_task_definition:gitea-task
  value: 3000
- operator: equals
  property: ContainerDefinitions[0].PortMappings[0].HostPort
  scope: resource
  target: aws:ecs_task_definition:gitea-task
  value: 3000
- operator: add
  property: ContainerDefinitions[0].PortMappings
  scope: resource
  target: aws:ecs_task_definition:gitea-task
  value:
  - ContainerPort: 2222
    HostPort: 2222
    Protocol: TCP
- operator: equals
  property: ContainerDefinitions[0].MountPoints[0].ContainerPath
  scope: resource
  target: aws:ecs_task_definition:gitea-task
  value: /data
- operator: equals
  property: ContainerDefinitions[0].MountPoints[0].SourceVolume
  scope: resource
  target: aws:ecs_task_definition:gitea-task
  value: gitea-data
- operator: equals
  property: ContainerDefinitions[0].MountPoints[1].ContainerPath
  scope: resource
  target: aws:ecs_task_definition:gitea-task
  value: /data/ssh
- operator: equals
  property: ContainerDefinitions[0].MountPoints[1].SourceVolume
  scope: resource
  target: aws:ecs_task_definition:gitea-task
  value: gitea-ssh
- operator: equals
  property: ContainerDefinitions[0].Cpu
  scope: resource
  target: aws:ecs_task_definition:gitea-task
  value: 512
- operator: equals
  property: ContainerDefinitions[0].Memory
  scope: resource
  target: aws:ecs_task_definition:gitea-task
  value: 2048
- operator: add
  property: ContainerDefinitions[0].Environment
  scope: resource
  target: aws:ecs_task_definition:gitea-task
  value:
  - Name: USER_UID
    Value: 1000
  - Name: USER_GID
    Value: 1000
  - Name: GITEA__database__DB_TYPE
    Value: postgres
  - Name: GITEA__database__HOST
    Value: aws:rds_instance:gitea-db#Endpoint
  - Name: GITEA__database__NAME
    Value: aws:rds_instance:gitea-db#DatabaseName
  - Name: GITEA__database__USER
    Value: aws:rds_instance:gitea-db#Username
  - Name: GITEA__database__PASSWD
    Value: aws:rds_instance:gitea-db#Password
- operator: equals
  property: Scheme
  scope: resource
  target: aws:load_balancer:gitea-lb
  value: internet-facing
- operator: equals
  property: LoadBalancer
  scope: resource
  target: aws:load_balancer_listener:gitea-lb:gitea-web
  value: aws:load_balancer:gitea-lb
- operator: equals
  property: Port
  scope: resource
  target: aws:load_balancer_listener:gitea-lb:gitea-web
  value: 80
- operator: equals
  property: Protocol
  scope: resource
  target: aws:load_balancer_listener:gitea-lb:gitea-web
  value: TCP
- operator: equals
  property: DefaultAction.Type
  scope: resource
  target: aws:load_balancer_listener:gitea-lb:gitea-web
  value: forward
- operator: equals
  property: DefaultAction.TargetGroup
  scope: resource
  target: aws:load_balancer_listener:gitea-lb:gitea-web
  value: aws:target_group:gitea-web
- operator: equals
  property: Port
  scope: resource
  target: aws:target_group:gitea-web
  value: 3000
- operator: equals
  property: Protocol
  scope: resource
  target: aws:target_group:gitea-web
  value: TCP
- operator: equals
  property: HealthCheck.Protocol
  scope: resource
  target: aws:target_group:gitea-web
  value: HTTP
- operator: equals
  property: HealthCheck.Path
  scope: resource
  target: aws:target_group:gitea-web
  value: /
- operator: equals
  property: HealthCheck.Matcher
  scope: resource
  target: aws:target_group:gitea-web
  value: 200-399
- operator: equals
  property: LoadBalancer
  scope: resource
  target: aws:load_balancer_listener:gitea-lb:gitea-ssh
  value: aws:load_balancer:gitea-lb
- operator: equals
  property: Port
  scope: resource
  target: aws:load_balancer_listener:gitea-lb:gitea-ssh
  value: 22
- operator: equals
  property: Protocol
  scope: resource
  target: aws:load_balancer_listener:gitea-lb:gitea-ssh
  value: TCP
- operator: equals
  property: DefaultAction.Type
  scope: resource
  target: aws:load_balancer_listener:gitea-lb:gitea-ssh
  value: forward
- operator: equals
  property: DefaultAction.TargetGroup
  scope: resource
  target: aws:load_balancer_listener:gitea-lb:gitea-ssh
  value: aws:target_group:gitea-ssh
- operator: equals
  property: Port
  scope: resource
  target: aws:target_group:gitea-ssh
  value: 22
- operator: equals
  property: Protocol
  scope: resource
  target: aws:target_group:gitea-ssh
  value: TCP
- operator: equals
  property: HealthCheck.Port
  scope: resource
  target: aws:target_group:gitea-ssh
  value: 3000
- operator: equals
  property: HealthCheck.Protocol
  scope: resource
  target: aws:target_group:gitea-ssh
  value: HTTP
- operator: equals
  property: HealthCheck.Path
  scope: resource
  target: aws:target_group:gitea-ssh
  value: /
- operator: equals
  property: HealthCheck.Matcher
  scope: resource
  target: aws:target_group:gitea-ssh
  value: 200-399
- operator: equals
  property: FileSystem
  scope: resource
  target: aws:efs_access_point:gitea-efs:gitea-data
  value: aws:efs_file_system:gitea-efs
- operator: equals
  property: PosixUser.Gid
  scope: resource
  target: aws:efs_access_point:gitea-efs:gitea-data
  value: 1000
- operator: equals
  property: PosixUser.Uid
  scope: resource
  target: aws:efs_access_point:gitea-efs:gitea-data
  value: 1000
- operator: equals
  property: RootDirectory.CreationInfo.OwnerGid
  scope: resource
  target: aws:efs_access_point:gitea-efs:gitea-data
  value: 1000
- operator: equals
  property: RootDirectory.CreationInfo.OwnerUid
  scope: resource
  target: aws:efs_access_point:gitea-efs:gitea-data
  value: 1000
- operator: equals
  property: RootDirectory.CreationInfo.Permissions
  scope: resource
  target: aws:efs_access_point:gitea-efs:gitea-data
  value: '777'
- operator: equals
  property: RootDirectory.Path
  scope: resource
  target: aws:efs_access_point:gitea-efs:gitea-data
  value: /mnt/data
- operator: equals
  property: FileSystem
  scope: resource
  target: aws:efs_access_point:gitea-efs:gitea-ssh
  value: aws:efs_file_system:gitea-efs
- operator: equals
  property: PosixUser.Gid
  scope: resource
  target: aws:efs_access_point:gitea-efs:gitea-ssh
  value: 0
- operator: equals
  property: PosixUser.Uid
  scope: resource
  target: aws:efs_access_point:gitea-efs:gitea-ssh
  value: 0
- operator: equals
  property: RootDirectory.CreationInfo.OwnerGid
  scope: resource
  target: aws:efs_access_point:gitea-efs:gitea-ssh
  value: 0
- operator: equals
  property: RootDirectory.CreationInfo.OwnerUid
  scope: resource
  target: aws:efs_access_point:gitea-efs:gitea-ssh
  value: 0
- operator: equals
  property: RootDirectory.CreationInfo.Permissions
  scope: resource
  target: aws:efs_access_point:gitea-efs:gitea-ssh
  value: '0700'
- operator: equals
  property: RootDirectory.Path
  scope: resource
  target: aws:efs_access_point:gitea-efs:gitea-ssh
  value: /mnt/ssh
- operator: must_exist
  scope: edge
  target:
    source: aws:load_balancer:gitea-lb
    target: aws:load_balancer_listener:gitea-lb:gitea-web
- operator: must_exist
  scope: edge
  target:
    source: aws:load_balancer_listener:gitea-lb:gitea-web
    target: aws:target_group:gitea-web
- operator: must_exist
  scope: edge
  target:
    source: aws:load_balancer:gitea-lb
    target: aws:load_balancer_listener:gitea-lb:gitea-ssh
- operator: must_exist
  scope: edge
  target:
    source: aws:load_balancer_listener:gitea-lb:gitea-ssh
    target: aws:target_group:gitea-ssh
- operator: must_exist
  scope: edge
  target:
    source: aws:load_balancer:gitea-lb
    target: aws:ecs_service:gitea-service
- operator: must_exist
  scope: edge
  target:
    source: aws:target_group:gitea-web
    target: aws:ecs_service:gitea-service
- operator: must_exist
  scope: edge
  target:
    source: aws:target_group:gitea-ssh
    target: aws:ecs_service:gitea-service
- operator: must_exist
  scope: edge
  target:
    source: aws:ecs_task_definition:gitea-task
    target: aws:efs_access_point:gitea-efs:gitea-data
- operator: must_exist
  scope: edge
  target:
    source: aws:efs_access_point:gitea-efs:gitea-data
    target: aws:efs_file_system:gitea-efs
- operator: must_exist
  scope: edge
  target:
    source: aws:ecs_task_definition:gitea-task
    target: aws:efs_access_point:gitea-efs:gitea-ssh
- operator: must_exist
  scope: edge
  target:
    source: aws:efs_access_point:gitea-efs:gitea-ssh
    target: aws:efs_file_system:gitea-efs
- operator: must_exist
  scope: edge
  target:
    source: aws:ecs_service:gitea-service
    target: aws:efs_file_system:gitea-efs
- operator: must_exist
  scope: edge
  target:
    source: aws:ecs_service:gitea-service
    target: aws:rds_instance:gitea-db
